#!/bin/bash

clear

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
apt update -y && apt install sudo -y 2>/dev/null
sudo apt-get update -y --fix-missing && sudo apt-get install wireguard-tools jq wget curl unzip zip xdg-utils -y --fix-missing

# –°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤
echo -n "–°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å? (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1): "
read count
count=${count:-1}

api="https://api.cloudflareclient.com/v0i1909051800"
ins() { curl -s -H 'user-agent:' -H 'content-type: application/json' -X "$1" "${api}/$2" "${@:3}"; }
sec() { ins "$1" "$2" -H "authorization: Bearer $3" "${@:4}"; }

mkdir -p warp_confs
downloader="https://knowerlife.github.io/downloader.html?filename="

clear

for i in $(seq 1 $count); do
  priv=$(wg genkey)
  pub=$(echo "$priv" | wg pubkey)

  response=$(ins POST "reg" -d "{\"install_id\":\"\",\"tos\":\"$(date -u +%FT%T.000Z)\",\"key\":\"${pub}\",\"fcm_token\":\"\",\"type\":\"ios\",\"locale\":\"en_US\"}")
  id=$(echo "$response" | jq -r '.result.id')
  token=$(echo "$response" | jq -r '.result.token')
  response=$(sec PATCH "reg/${id}" "$token" -d '{"warp_enabled":true}')

  peer_pub=$(echo "$response" | jq -r '.result.config.peers[0].public_key')
  ip_suffix=$((100 + i))
  client_ip="10.10.8.${ip_suffix}"

  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–º–µ–Ω–∏
  random_name="warp_$(tr -dc A-Za-z0-9 </dev/urandom | head -c 8)"
  file_path="warp_confs/${random_name}.conf"

  cat > "$file_path" <<EOF
[Interface]
Address = ${client_ip}/24
PrivateKey = ${priv}

[Peer]
PublicKey = ${peer_pub}
Endpoint = 203.0.113.2:34567
AllowedIPs = 10.10.8.0/24, 192.168.111.0/24
PersistentKeepalive = 25
EOF

  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è base64-—Å—Å—ã–ª–∫–∏
  encoded=$(base64 -w 0 < "$file_path")
  download_url="${downloader}${random_name}.conf&content=${encoded}"

  echo "üì• ${random_name}.conf:"
  echo "$download_url"
  
  # –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–∫–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
  command -v xdg-open &>/dev/null && xdg-open "$download_url" &
done

# –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
zip -r -q warp_confs.zip warp_confs

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω
PORT=8000
while lsof -i :$PORT &>/dev/null; do
  ((PORT++))
done

echo -e "\nüóÇÔ∏è –ê—Ä—Ö–∏–≤: warp_confs.zip"
echo "üåç –°–∫–∞—á–∞–π—Ç–µ –≤–µ—Å—å –∞—Ä—Ö–∏–≤ –ø–æ —Å—Å—ã–ª–∫–µ:"
ip=$(hostname -I | awk '{print $1}')
echo "üëâ http://${ip}:${PORT}/warp_confs.zip"
xdg-open "http://${ip}:${PORT}/warp_confs.zip" &

# –ó–∞–ø—É—Å–∫ http-—Å–µ—Ä–≤–µ—Ä–∞
echo -e "\n–ù–∞–∂–º–∏—Ç–µ Ctrl+C, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä."
python3 -m http.server "$PORT"
